#!/bin/bash
################################################################################
# F2B Unified Wrapper v0.19 - PRODUCTION
# Complete Fail2Ban + nftables + docker-block management
#
# v0.19 Changes:
#   + Lock mechanizmus (mutex)
#   + Port validation
#   + Persistent logging
#   + Enhanced top attackers (historical)
#   + Attack trend analysis
#   + Jail log filter
#   + Export JSON/CSV reports
#   + VÅ¡etky funkcie z v0.18 zachovanÃ©
################################################################################

set -o pipefail

VERSION="0.19"
DOCKERBLOCKVERSION="0.3"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Configuration
F2BTABLE="inet fail2ban-filter"
BACKUPDIR="/var/backups/firewall"
LOGFILE="/var/log/f2b-wrapper.log"
LOCKFILE="/tmp/f2b-wrapper.lock"

# Jails list
JAILS=(
    "sshd"
    "f2b-exploit-critical"
    "f2b-dos-high"
    "f2b-web-medium"
    "nginx-recon-bonus"
    "recidive"
    "manualblock"
    "f2b-fuzzing-payloads"
    "f2b-botnet-signatures"
    "f2b-anomaly-detection"
)

# Jail to nftables set mapping
declare -A SETMAP=(
    ["sshd"]="f2b-sshd"
    ["f2b-exploit-critical"]="f2b-exploit-critical"
    ["f2b-dos-high"]="f2b-dos-high"
    ["f2b-web-medium"]="f2b-web-medium"
    ["nginx-recon-bonus"]="f2b-nginx-recon-bonus"
    ["recidive"]="f2b-recidive"
    ["manualblock"]="f2b-manualblock"
    ["f2b-fuzzing-payloads"]="f2b-fuzzing-payloads"
    ["f2b-botnet-signatures"]="f2b-botnet-signatures"
    ["f2b-anomaly-detection"]="f2b-anomaly-detection"
)

################################################################################
# LOGGING FUNCTIONS
################################################################################

log_success() {
    echo -e "${GREEN}[OK]${NC} $1" | tee -a "$LOGFILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOGFILE"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1" | tee -a "$LOGFILE"
}

log_info() {
    echo -e "${CYAN}[INFO]${NC} $1" | tee -a "$LOGFILE"
}

log_header() {
    echo -e "\n${BLUE}$1${NC}\n" | tee -a "$LOGFILE"
}

log_alert() {
    echo -e "${MAGENTA}[ALERT]${NC} $1" | tee -a "$LOGFILE"
}

################################################################################
# LOCK MECHANISM (NEW v0.19)
################################################################################

acquire_lock() {
    if [ -f "$LOCKFILE" ]; then
        log_error "Another f2b operation is in progress"
        log_error "If stuck, remove: $LOCKFILE"
        exit 1
    fi
    touch "$LOCKFILE"
    trap 'rm -f "$LOCKFILE"' EXIT INT TERM
}

release_lock() {
    rm -f "$LOCKFILE"
}

################################################################################
# VALIDATION FUNCTIONS (NEW v0.19)
################################################################################

validate_port() {
    local port="$1"
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        log_error "Invalid port number: $port (must be 1-65535)"
        return 1
    fi
    return 0
}

validate_ip() {
    local ip="$1"
    if [[ ! "$ip" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        log_error "Invalid IP address: $ip"
        return 1
    fi
    return 0
}

################################################################################
# HELPER FUNCTIONS
################################################################################

get_f2b_count() {
    local jail="$1"
    local count=$(sudo fail2ban-client status "$jail" 2>/dev/null | grep "Currently banned" | awk '{print $NF}')
    echo "${count:-0}"
}

get_f2b_ips() {
    local jail="$1"
    sudo fail2ban-client status "$jail" 2>/dev/null | \
        grep "Banned IP list:" | \
        sed 's/.*Banned IP list:\s*//' | \
        tr ' ' '\n' | \
        grep -E '[0-9]' | \
        sort -u
}

get_nft_ips() {
    local set="$1"
    sudo nft list set $F2BTABLE "$set" 2>/dev/null | \
        grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]+)?' | \
        sort -u
}

count_ips() {
    local ips="$1"
    if [ -z "$ips" ]; then
        echo 0
    else
        echo "$ips" | wc -l
    fi
}

################################################################################
# CORE FUNCTIONS
################################################################################

f2b_version() {
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  F2B Wrapper v${VERSION}"
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Components:"
    echo "  - Fail2Ban + nftables integration"
    echo "  - Docker port blocking (v${DOCKERBLOCKVERSION})"
    echo "  - Enhanced sync & monitoring"
    echo "  - Complete management suite"
    echo "  - Attack trend analysis (NEW)"
    echo "  - Export reports JSON/CSV (NEW)"
    echo ""
}

f2b_status() {
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  F2B System Status v${VERSION}"
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    echo "ğŸ“Š Services:"
    systemctl is-active --quiet nftables && log_success "nftables: active" || log_error "nftables: inactive"
    systemctl is-active --quiet fail2ban && log_success "fail2ban: active" || log_error "fail2ban: inactive"
    systemctl is-active --quiet ufw && log_success "ufw: active" || log_warn "ufw: inactive"
   # systemctl is-active --quiet f2b-nft-sync.timer && log_success "auto-sync: active" || log_warn "auto-sync: inactive"
    
    echo ""
    echo "ğŸ›¡ï¸  Active Jails:"
    sudo fail2ban-client status 2>/dev/null | grep "Jail list:" | sed 's/.*Jail list:\s*//' | tr ',' '\n' | sed 's/^[ \t]*/  - /' || log_error "Could not retrieve jails"
    
    echo ""
    echo "ğŸ“‹ NFT Tables:"
    sudo nft list tables 2>/dev/null | grep -E 'fail2ban|docker-block' | sed 's/^/  /' || echo "  none"
    
    echo ""
    echo "ğŸ‹ docker-block v${DOCKERBLOCKVERSION}:"
    if sudo nft list table inet docker-block &>/dev/null; then
        log_success "Active (external blocking, localhost allowed)"
        sudo nft list set inet docker-block docker-blocked-ports 2>/dev/null | grep "elements" | sed 's/^\s*/  /' || echo "  No blocked ports"
    else
        log_warn "Not configured"
    fi
    echo ""
}

f2b_audit() {
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Fail2Ban Audit"
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    local total=0
    local clean=0
    
    for jail in "${JAILS[@]}"; do
        local count=$(get_f2b_count "$jail")
        if [ "$count" -eq 0 ]; then
            log_success "[$jail] clean"
            ((clean++))
        else
            log_warn "[$jail] $count IPs"
        fi
        ((total+=count))
    done
    
    echo ""
    log_info "Total Jails: ${#JAILS[@]}"
    log_info "Clean: $clean"
    log_info "Total IPs: $total"
    
    if [ "$total" -eq 0 ]; then
        log_success "âœ… ALL CLEAN!"
    else
        log_warn "Active bans: $total"
    fi
    echo ""
}

f2b_find() {
    local IP="$1"
    if [ -z "$IP" ]; then
        log_error "Usage: f2b find <IP>"
        return 1
    fi
    
    if ! validate_ip "$IP"; then
        return 1
    fi
    
    log_header "Searching for $IP"
    
    local found=0
    for jail in "${JAILS[@]}"; do
        if sudo fail2ban-client status "$jail" 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | grep -q "$IP"; then
            log_success "Found in jail: $jail"
            
            local bantime=$(sudo fail2ban-client get "$jail" bantime 2>/dev/null || echo "unknown")
            log_info "Ban time: $bantime"
            
            local nftset="${SETMAP[$jail]}"
            if sudo nft list set $F2BTABLE "$nftset" 2>/dev/null | grep -qE "$IP"; then
                log_info "nftables: Present in $nftset"
            else
                log_warn "nftables: NOT in $nftset (sync issue!)"
            fi
            
            found=1
        fi
    done
    
    echo ""
    if [ "$found" -eq 0 ]; then
        log_error "IP $IP not found in any jail"
        return 1
    else
        log_success "Search complete"
        return 0
    fi
}

################################################################################
# SYNC FUNCTIONS
################################################################################

f2b_sync_check() {
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Fail2Ban â†” nftables Sync Check"
    log_header "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    local ALLSYNCED=true
    
    for jail in "${JAILS[@]}"; do
        local F2BCOUNT=$(get_f2b_count "$jail")
        local nftset="${SETMAP[$jail]}"
        local NFTCOUNT=$(get_nft_ips "$nftset" | wc -l)
        
        local DIFF=$((F2BCOUNT - NFTCOUNT))
        local DIFFABS=${DIFF#-}
        
        if [ "$F2BCOUNT" -eq "$NFTCOUNT" ]; then
            log_success "[$jail] $F2BCOUNT == $NFTCOUNT"
        elif [ "$DIFFABS" -le 1 ]; then
            log_success "[$jail] $F2BCOUNT == $NFTCOUNT (Â±1 range merge)"
        else
            log_warn "[$jail] F2B=$F2BCOUNT, nft=$NFTCOUNT (MISMATCH)"
            ALLSYNCED=false
        fi
    done
    
    echo ""
    if $ALLSYNCED; then
        log_success "[OK] All jails synchronized!"
    else
        log_warn "Some jails out of sync - run 'f2b sync force'"
    fi
    echo ""
}

f2b_sync_enhanced() {
    log_header "F2B SYNC ENHANCED (Bidirectional)"
    
    local removed=0
    local added=0
    
    log_header "Phase 1: Remove orphaned IPs"
    for jail in "${JAILS[@]}"; do
        local nftset="${SETMAP[$jail]}"
        local f2b_ips=$(get_f2b_ips "$jail")
        local nft_ips=$(get_nft_ips "$nftset")
        local f2b_count=$(count_ips "$f2b_ips")
        local nft_count=$(count_ips "$nft_ips")
        
        log_info "[$jail] F2B=$f2b_count, NFT=$nft_count"
        
        if [ -z "$f2b_ips" ]; then
            while read -r ip; do
                [ -n "$ip" ] && sudo nft delete element $F2BTABLE "$nftset" "{ $ip }" 2>/dev/null && ((removed++))
            done <<< "$nft_ips"
        else
            while read -r ip; do
                [ -n "$ip" ] && ! echo "$f2b_ips" | grep -q "$ip" && sudo nft delete element $F2BTABLE "$nftset" "{ $ip }" 2>/dev/null && ((removed++))
            done <<< "$nft_ips"
        fi
    done
    
    echo ""
    log_header "Phase 2: Add missing IPs"
    for jail in "${JAILS[@]}"; do
        local nftset="${SETMAP[$jail]}"
        local f2b_ips=$(get_f2b_ips "$jail")
        local nft_ips=$(get_nft_ips "$nftset")
        
        while read -r ip; do
            [ -n "$ip" ] && ! echo "$nft_ips" | grep -q "$ip" && sudo nft add element $F2BTABLE "$nftset" "{ $ip }" 2>/dev/null && ((added++))
        done <<< "$f2b_ips"
    done
    
    echo ""
    log_header "SYNC REPORT"
    log_success "Removed orphaned: $removed"
    log_success "Added missing: $added"
    
    if [ "$removed" -gt 0 ] || [ "$added" -gt 0 ]; then
        log_success "âœ… Synchronization completed!"
    else
        log_warn "No changes needed"
    fi
    echo ""
}

f2b_sync_force() {
    f2b_sync_enhanced
    f2b_sync_check
}

sync_silent() {
    # Silent sync for cron - logs only errors
    local LOG_FILE="/var/log/f2b-sync.log"
    local CHANGES=0
    
    {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting silent sync..."
        
        for jail in "${JAILS[@]}"; do
            local nftset="${SETMAP[$jail]}"
            local f2b_ips=$(get_f2b_ips "$jail")
            local nft_ips=$(get_nft_ips "$nftset")
            
            # Remove orphaned
            if [ -z "$f2b_ips" ]; then
                while read -r ip; do
                    [ -n "$ip" ] && sudo nft delete element $F2BTABLE "$nftset" "{ $ip }" 2>/dev/null && ((CHANGES++)) && echo "  Removed orphan: $ip from $jail"
                done <<< "$nft_ips"
            else
                while read -r ip; do
                    [ -n "$ip" ] && ! echo "$f2b_ips" | grep -q "$ip" && sudo nft delete element $F2BTABLE "$nftset" "{ $ip }" 2>/dev/null && ((CHANGES++)) && echo "  Removed orphan: $ip from $jail"
                done <<< "$nft_ips"
            fi
            
            # Add missing
            while read -r ip; do
                [ -n "$ip" ] && ! echo "$nft_ips" | grep -q "$ip" && sudo nft add element $F2BTABLE "$nftset" "{ $ip }" 2>/dev/null && ((CHANGES++)) && echo "  Added missing: $ip to $jail"
            done <<< "$f2b_ips"
        done
        
        if [ "$CHANGES" -eq 0 ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Sync OK - no changes"
        else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Sync completed - $CHANGES changes"
        fi
    } >> "$LOG_FILE" 2>&1
}

################################################################################
# MANAGE FUNCTIONS
################################################################################

manage_block_port() {
    local port="$1"
    if [ -z "$port" ]; then
        log_error "Usage: manage block-port <port>"
        return 1
    fi
    
    if ! validate_port "$port"; then
        return 1
    fi
    
    log_header "Blocking port $port"
    if sudo nft add element inet docker-block docker-blocked-ports "{ $port }" 2>/dev/null; then
        log_success "Port $port blocked"
    else
        log_warn "Port $port might already be blocked or docker-block table missing"
    fi
    echo ""
}

manage_unblock_port() {
    local port="$1"
    if [ -z "$port" ]; then
        log_error "Usage: manage unblock-port <port>"
        return 1
    fi
    
    if ! validate_port "$port"; then
        return 1
    fi
    
    log_header "Unblocking port $port"
    if sudo nft delete element inet docker-block docker-blocked-ports "{ $port }" 2>/dev/null; then
        log_success "Port $port unblocked"
    else
        log_error "Port $port not found"
    fi
    echo ""
}

manage_list_blocked_ports() {
    log_header "BLOCKED PORTS"
    sudo nft list set inet docker-block docker-blocked-ports 2>/dev/null || log_warn "No blocked ports or docker-block table missing"
    echo ""
}

manage_manual_ban() {
    local ip="$1"
    local timeout="${2:-7d}"
    
    if [ -z "$ip" ]; then
        log_error "Usage: manage manual-ban <ip> [timeout]"
        return 1
    fi
    
    if ! validate_ip "$ip"; then
        return 1
    fi
    
    log_header "Banning $ip ($timeout)"
    if sudo nft add element $F2BTABLE f2b-manualblock "{ $ip timeout $timeout }" 2>/dev/null; then
        log_success "Banned"
    else
        log_warn "Already banned"
    fi
    echo ""
}

manage_manual_unban() {
    local ip="$1"
    if [ -z "$ip" ]; then
        log_error "Usage: manage manual-unban <ip>"
        return 1
    fi
    
    if ! validate_ip "$ip"; then
        return 1
    fi
    
    log_header "Unbanning $ip"
    if sudo nft delete element $F2BTABLE f2b-manualblock "{ $ip }" 2>/dev/null; then
        log_success "Unbanned"
    else
        log_error "Not found"
    fi
    echo ""
}

manage_reload() {
    log_header "Reloading firewall"
    
    if sudo nft -c -f /etc/nftables.conf 2>/dev/null; then
        log_success "Syntax OK"
    else
        log_error "Syntax error"
        return 1
    fi
    
    if sudo systemctl reload nftables 2>/dev/null; then
        log_success "Reloaded"
    else
        sudo systemctl restart nftables
        log_success "Restarted"
    fi
    echo ""
}

manage_backup() {
    local file="$BACKUPDIR/firewall-$(date +%Y%m%d-%H%M%S).tar.gz"
    mkdir -p "$BACKUPDIR"
    
    log_header "Backing up..."
    sudo tar czf "$file" \
        /etc/nftables.conf \
        /etc/nftables.d/ \
        /etc/nftables/*.nft \
        /etc/fail2ban/jail.d/ \
        2>/dev/null || true
    log_success "Backup: $file"
    echo ""
}

f2b_docker_info() {
    echo ""
    log_header "ğŸ‹ docker-block v${DOCKERBLOCKVERSION} - Status"
    echo ""
    
    if sudo nft list table inet docker-block &>/dev/null; then
        log_success "docker-block table: ACTIVE"
        echo ""
        echo "Behavior:"
        echo "  â€¢ localhost (127.0.0.1): ALLOWED"
        echo "  â€¢ Docker bridge (docker0): ALLOWED"
        echo "  â€¢ External access: BLOCKED"
        echo ""
        echo "Blocked ports:"
        sudo nft list set inet docker-block docker-blocked-ports 2>/dev/null | grep "elements" || echo "  (none)"
    else
        log_error "docker-block table: NOT FOUND"
        echo ""
        echo "To install:"
        echo "  bash docker-block-v0.3-fix.sh"
    fi
    echo ""
}

################################################################################
# MONITOR FUNCTIONS
################################################################################

monitor_status() {
    log_header "FIREWALL STATUS"
    
    echo ""
    echo "Services:"
    echo "  nftables: $(sudo systemctl is-active nftables)"
    echo "  fail2ban: $(sudo systemctl is-active fail2ban)"
    echo "  ufw: $(sudo systemctl is-active ufw)"
    echo ""
    
    echo "IPv4 Sets (10/10):"
    echo ""
    
    echo "Active Jails:"
    local active=0
    for jail in "${JAILS[@]}"; do
        local count=$(get_f2b_count "$jail")
        if [ "$count" -gt 0 ]; then
            echo "  $jail: $count"
            ((active++))
        fi
    done
    
    if [ "$active" -eq 0 ]; then
        echo "  (all clean)"
    fi
    echo ""
}

monitor_show_bans() {
    local jail="${1:-all}"
    log_header "BANNED IPs"
    
    if [ "$jail" = "all" ]; then
        for j in "${JAILS[@]}"; do
            local ips=$(get_f2b_ips "$j")
            if [ -n "$ips" ]; then
                echo "$j:"
                echo "$ips" | sed 's/^/  /'
                echo ""
            fi
        done
    else
        local ips=$(get_f2b_ips "$jail")
        if [ -n "$ips" ]; then
            echo "$jail:"
            echo "$ips" | sed 's/^/  /'
        else
            log_warn "No IPs banned in $jail"
        fi
    fi
    echo ""
}

monitor_top_attackers() {
    log_header "TOP ATTACKERS (Historical)"
    
    if [ ! -f /var/log/fail2ban.log ]; then
        log_error "Fail2Ban log not found"
        return 1
    fi
    
    local temp_file="/tmp/attackers-$$.tmp"
    
    # Extract IPs from ban events in last 1000 lines
    grep -h "Ban" /var/log/fail2ban.log 2>/dev/null | \
        tail -1000 | \
        grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | \
        sort | uniq -c | sort -rn | head -10 > "$temp_file" 2>/dev/null || true
    
    if [ ! -s "$temp_file" ]; then
        log_info "No attack data available"
        rm -f "$temp_file"
        return 0
    fi
    
    echo ""
    local rank=1
    while IFS= read -r line; do
        local count=$(echo "$line" | awk '{print $1}')
        local ip=$(echo "$line" | awk '{print $2}')
        echo -e "${YELLOW}$rank.${NC} $ip ${RED}($count bans)${NC}"
        rank=$((rank + 1))
    done < "$temp_file"
    
    rm -f "$temp_file"
    echo ""
}

monitor_watch() {
    while true; do
        clear
        echo "==========================================="
        echo "  REAL-TIME MONITORING"
        echo "==========================================="
        echo ""
        
        local total=0
        for jail in "${JAILS[@]}"; do
            local count=$(get_f2b_count "$jail")
            if [ "$count" -gt 0 ]; then
                echo "  $jail: $count"
                ((total+=count))
            fi
        done
        
        echo ""
        echo "Total: $total"
        echo ""
        echo "Updated: $(date '+%H:%M:%S')"
        echo "Press Ctrl+C to exit"
        echo ""
        sleep 5
    done
}

monitor_jail_log() {
    local jail="$1"
    local lines="${2:-20}"
    
    if [ -z "$jail" ]; then
        log_error "Usage: monitor jail-log <jail> [lines]"
        return 1
    fi
    
    log_header "Recent activity for jail: $jail"
    echo ""
    
    if [ ! -f /var/log/fail2ban.log ]; then
        log_error "Fail2Ban log not found"
        return 1
    fi
    
    grep "\[$jail\]" /var/log/fail2ban.log 2>/dev/null | tail -n "$lines" || \
        log_warn "No logs found for $jail"
    echo ""
}

monitor_trends() {
    log_header "ATTACK TREND ANALYSIS"
    
    if [ ! -f /var/log/fail2ban.log ]; then
        log_error "Fail2Ban log not found"
        return 1
    fi
    
    echo ""
    
    # Count attacks in different time windows
    local last_hour=$(grep "$(date -d '1 hour ago' +%Y-%m-%d\ %H)" /var/log/fail2ban.log 2>/dev/null | grep -c "Ban\|Found" || echo "0")
    local last_6h=$(grep "$(date -d '6 hours ago' +%Y-%m-%d)" /var/log/fail2ban.log 2>/dev/null | grep -c "Ban\|Found" || echo "0")
    local last_24h=$(grep "$(date -d '1 day ago' +%Y-%m-%d)" /var/log/fail2ban.log 2>/dev/null | grep -c "Ban\|Found" || echo "0")
    
    echo -e "Last hour:    ${YELLOW}$last_hour${NC} attempts"
    echo -e "Last 6h:      ${YELLOW}$last_6h${NC} attempts"
    echo -e "Last 24h:     ${YELLOW}$last_24h${NC} attempts"
    echo ""
    
    # Threat assessment
    if [ "$last_hour" -gt 50 ]; then
        log_alert "âš ï¸  CRITICAL: HIGH ATTACK INTENSITY!"
        echo ""
        log_info "Recommended actions:"
        log_info "  â€¢ Review logs: f2b monitor jail-log <jail>"
        log_info "  â€¢ Check top attackers: f2b monitor top-attackers"
        log_info "  â€¢ Consider enabling stricter rules"
    elif [ "$last_hour" -gt 20 ]; then
        log_warn "âš ï¸  WARNING: Elevated attack activity"
    else
        log_success "âœ… Attack levels normal"
    fi
    echo ""
}

################################################################################
# REPORT FUNCTIONS (NEW v0.19)
################################################################################

report_json() {
    log_header "JSON EXPORT"
    
    local total_bans=0
    local jail_stats=""
    
    for jail in "${JAILS[@]}"; do
        local count=$(get_f2b_count "$jail")
        total_bans=$((total_bans + count))
        jail_stats="${jail_stats}    \"$jail\": $count,\n"
    done
    
    # Remove trailing comma
    jail_stats=$(echo -e "$jail_stats" | sed '$ s/,$//')
    
    cat << EOF
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "version": "$VERSION",
  "services": {
    "nftables": "$(systemctl is-active nftables 2>/dev/null || echo 'unknown')",
    "fail2ban": "$(systemctl is-active fail2ban 2>/dev/null || echo 'unknown')",
    "docker_block": "$(sudo nft list table inet docker-block &>/dev/null && echo 'active' || echo 'inactive')"
  },
  "statistics": {
    "total_bans": $total_bans,
    "jails": {
$(echo -e "$jail_stats")
    }
  },
  "generated_by": "F2B Wrapper v$VERSION"
}
EOF
    echo ""
}

report_csv() {
    log_header "CSV EXPORT"
    
    echo "Timestamp,Jail,Banned_IPs,Status"
    
    for jail in "${JAILS[@]}"; do
        local count=$(get_f2b_count "$jail")
        local status="active"
        [ "$count" -eq 0 ] && status="clean"
        echo "$(date +%Y-%m-%d\ %H:%M:%S),$jail,$count,$status"
    done
    
    echo ""
}

report_daily() {
    log_header "DAILY REPORT"
    
    echo "Generated: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    
    # Service status
    echo "Services:"
    echo "  nftables: $(systemctl is-active nftables 2>/dev/null || echo 'unknown')"
    echo "  fail2ban: $(systemctl is-active fail2ban 2>/dev/null || echo 'unknown')"
    echo ""
    
    # Jail statistics
    echo "Jail Statistics:"
    local total=0
    for jail in "${JAILS[@]}"; do
        local count=$(get_f2b_count "$jail")
        [ "$count" -gt 0 ] && echo "  $jail: $count"
        total=$((total + count))
    done
    echo ""
    echo "Total banned IPs: $total"
    echo ""
    
    # Top attackers
    echo "Top 5 Attackers:"
    if [ -f /var/log/fail2ban.log ]; then
        grep -h "Ban" /var/log/fail2ban.log 2>/dev/null | \
            tail -500 | \
            grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | \
            sort | uniq -c | sort -rn | head -5 | \
            awk '{print "  " $2 " (" $1 " bans)"}'
    else
        echo "  (log not available)"
    fi
    echo ""
}

audit_silent() {
    # Silent audit for cron
    local LOG_FILE="/var/log/f2b-audit.log"
    local TOTAL=0
    
    {
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Audit started"
        
        for jail in "${JAILS[@]}"; do
            local count=$(get_f2b_count "$jail")
            TOTAL=$((TOTAL + count))
            [ "$count" -gt 0 ] && echo "  $jail: $count IPs"
        done
        
        if [ "$TOTAL" -eq 0 ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Status: ALL CLEAN"
        else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Total banned: $TOTAL"
        fi
    } >> "$LOG_FILE" 2>&1
}

stats_quick() {
    # Quick stats for dashboard
    local total=0
    for jail in "${JAILS[@]}"; do
        local count=$(get_f2b_count "$jail")
        total=$((total + count))
    done
    echo "Total: $total | nftables: $(systemctl is-active nftables 2>/dev/null) | fail2ban: $(systemctl is-active fail2ban 2>/dev/null)"
}

################################################################################
# HELP
################################################################################

show_help() {
    cat << 'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         F2B UNIFIED WRAPPER v0.19
    Fail2Ban + nftables Complete Management
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USAGE: f2b <command> <subcommand> [args]

CORE:
  status                       Show comprehensive status
  audit                        Audit all jails
  find <IP>                    Find IP in jails
  version                      Show version info

SYNC:
  sync check                   Verify F2B â†” nftables sync
  sync enhanced                Enhanced bidirectional sync
  sync force                   Force sync + verify
  sync silent                  Silent sync (for cron)

MANAGE - PORT BLOCKING:
  manage block-port <port>         Block Docker port
  manage unblock-port <port>       Unblock port
  manage list-blocked-ports        List blocked ports
  manage docker-info               Show docker-block status

MANAGE - IP BAN/UNBAN:
  manage manual-ban <ip> [time]    Ban IP manually
  manage manual-unban <ip>         Unban IP
  
MANAGE - SYSTEM:
  manage reload                    Reload firewall
  manage backup                    Backup configuration

MONITOR:
  monitor status                   System overview
  monitor show-bans [jail]         Show banned IPs
  monitor top-attackers            Top 10 attackers (historical)
  monitor watch                    Real-time monitoring
  monitor jail-log <jail> [lines]  Show jail log (NEW)
  monitor trends                   Attack trend analysis (NEW)

REPORTS:
  report json                      Export as JSON (NEW)
  report csv                       Export as CSV (NEW)
  report daily                     Daily summary report
  
SILENT (for cron):
  audit-silent                     Silent audit
  stats-quick                      Quick stats

EXAMPLES:
  sudo f2b status
  sudo f2b audit
  sudo f2b find 1.2.3.4
  sudo f2b sync force
  sudo f2b manage block-port 8081
  sudo f2b manage manual-ban 192.0.2.1 30d
  sudo f2b monitor trends
  sudo f2b monitor jail-log sshd 50
  sudo f2b report json > /tmp/f2b-report.json
  sudo f2b monitor watch

ALIASES (if configured):
  f2b-status, f2b-audit, f2b-sync, f2b-find, f2b-watch
  f2b-block-port, f2b-unblock-port, f2b-list-ports
  f2b-ban, f2b-unban

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
}

################################################################################
# MAIN ROUTING
################################################################################

main() {
    # Acquire lock for write operations
    case "$1" in
        sync|manage)
            acquire_lock
            ;;
    esac
    
    case "$1" in
        # Core commands
        status)
            f2b_status
            ;;
        audit)
            f2b_audit
            ;;
        find)
            f2b_find "$2"
            ;;
        version|--version|-v)
            f2b_version
            ;;
            
        # Sync commands
        sync)
            case "$2" in
                check) f2b_sync_check ;;
                enhanced) f2b_sync_enhanced ;;
                force) f2b_sync_force ;;
                silent) sync_silent ;;
                *) show_help ;;
            esac
            ;;
            
        # Manage commands
        manage)
            case "$2" in
                block-port) manage_block_port "$3" ;;
                unblock-port) manage_unblock_port "$3" ;;
                list-blocked-ports) manage_list_blocked_ports ;;
                docker-info) f2b_docker_info ;;
                manual-ban) manage_manual_ban "$3" "$4" ;;
                manual-unban) manage_manual_unban "$3" ;;
                reload) manage_reload ;;
                backup) manage_backup ;;
                *) show_help ;;
            esac
            ;;
            
        # Monitor commands
        monitor)
            case "$2" in
                status) monitor_status ;;
                show-bans) monitor_show_bans "$3" ;;
                top-attackers) monitor_top_attackers ;;
                watch) monitor_watch ;;
                jail-log) monitor_jail_log "$3" "$4" ;;
                trends) monitor_trends ;;
                *) show_help ;;
            esac
            ;;
            
        # Report commands
        report)
            case "$2" in
                json) report_json ;;
                csv) report_csv ;;
                daily) report_daily ;;
                *) show_help ;;
            esac
            ;;
            
        # Silent commands (for cron)
        audit-silent)
            audit_silent
            ;;
        stats-quick)
            stats_quick
            ;;
            
        # Help
        help|--help|-h|"")
            show_help
            ;;
            
        *)
            log_error "Unknown command: $1"
            show_help
            return 1
            ;;
    esac
}

# Initialize log file
mkdir -p "$(dirname "$LOGFILE")"
touch "$LOGFILE"

main "$@"


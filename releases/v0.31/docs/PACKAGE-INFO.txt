â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                â•‘
â•‘    Fail2Ban + nftables v0.31 - Production Bundle               â•‘
â•‘      One-Click IPv4 + IPv6 + Docker-Block Security System      â•‘
â•‘                 (Immediate Docker Ban Edition)                 â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERSION: 0.31
WRAPPER VERSION: 0.32
RELEASE DATE: December 26, 2025
UPGRADE FROM: v0.19â€“v0.30 (auto-detect)
LICENSE: MIT


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
KEY CHANGES IN v0.31
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ IMMEDIATE DOCKER-BLOCK BAN (NO CRON DELAY):
  âœ… New Fail2Ban action: docker-sync-hook.conf
     â€¢ Calls f2b-docker-hook.sh on ban/unban
     â€¢ Parameters: ban|unban <ip> <jail> <bantime>
  âœ… f2b-docker-hook.sh:
     â€¢ Adds/removes IP to/from nftables sets:
       - docker-banned-ipv4
       - docker-banned-ipv6
     â€¢ Uses table inet docker-block
     â€¢ Sets element timeout equal to Fail2Ban bantime
  âœ… Result:
     â€¢ Docker traffic is blocked immediately when Fail2Ban bans an IP
     â€¢ Cron is used only for validation/repair, not for initial ban

ğŸ§© CONSOLIDATED v0.31 STRUCTURE:
  âœ… Finalized nftables layout (same counts as v0.30):
     â€¢ 11 IPv4 sets + 11 IPv6 sets (f2b-*)
     â€¢ 22 INPUT rules (11 IPv4 + 11 IPv6)
     â€¢ 6 FORWARD rules (backend protection)
  âœ… 11 Fail2Ban jails + 11 detection filters:
     â€¢ sshd, sshd-slowattack
     â€¢ f2b-exploit-critical, f2b-dos-high, f2b-web-medium
     â€¢ nginx-recon-optimized, recidive, manualblock
     â€¢ f2b-fuzzing-payloads, f2b-botnet-signatures, f2b-anomaly-detection
  âœ… Unified naming and inet family:
     â€¢ addr_set = f2b-<name> (IPv4)
     â€¢ addr_set = f2b-<name>-v6 (IPv6)
     â€¢ table = fail2ban-filter
     â€¢ chain = f2b-input
     â€¢ table_family = inet

ğŸ“Š WRAPPER v0.32 (v0.31 RELEASE WRAPPER):
  âœ… Lock mechanism:
     â€¢ Uses /tmp/f2b-wrapper.lock to prevent concurrent runs
  âœ… Improved validation:
     â€¢ IPv6 validation via ip(8) with safe fallback
     â€¢ Stricter port validation
  âœ… jq helpers:
     â€¢ jq_safe_parse and jq_prettify for safe nft -j JSON parsing
  âœ… Extended reporting:
     â€¢ f2b report json / csv / daily
     â€¢ f2b report attack-analysis (NPM + SSH)
     â€¢ f2b audit-silent (silent mode for cron)
     â€¢ f2b stats-quick (fast summary)
  âœ… Metadata:
     â€¢ Unified RELEASE / VERSION / BUILD_DATE / COMPONENT_NAME headers

ğŸ‹ DOCKER-BLOCK v0.4 + VALIDATE MODE:
  âœ… docker-block table (inet docker-block):
     â€¢ docker-blocked-ports (service ports)
     â€¢ docker-banned-ipv4 / docker-banned-ipv6
  âœ… Validate cron (instead of primary banning):
     â€¢ Root cron runs every minute:
       - f2b docker sync validate
     â€¢ Uses flock locking
     â€¢ Logs to /var/log/f2b-docker-sync.log
  âœ… Purpose:
     â€¢ Validate and repair docker-block sets according to Fail2Ban
     â€¢ Primary ban path is now the immediate hook (f2b-docker-hook.sh)

ğŸ§¹ SAFE PRE-CLEANUP AND AUTO-SYNC (UPDATED FOR v0.31):
  âœ… 00-pre-cleanup-v031.sh:
     â€¢ Backups: nftables ruleset + fail2ban configs
     â€¢ Cleans legacy systemd units, cron entries and aliases from older versions
  âœ… 05-install-auto-sync-v031.sh:
     â€¢ Performs initial full Fail2Ban â†’ nftables sync (IPv4 + IPv6)
     â€¢ Compares IP counts and prints a summary for auditing


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PACKAGE CONTENTS (v0.31)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¦ ROOT:
  âœ… INSTALL-ALL-v031.sh              Universal installer (one-click v0.31)
  âœ… README.md                        Main usage guide (updated for v0.31)
  âœ… CHANGELOG.md                     Version history (includes v0.31)
  âœ… PACKAGE-INFO.txt                 This file

ğŸ“‚ scripts/ (core logic):
  âœ… 00-pre-cleanup-v031.sh           Pre-install cleanup, backup, legacy removal
  âœ… 01-install-nftables-v031.sh      nftables infrastructure (11+11 sets, 22+6 rules)
  âœ… 02-install-jails-v031.sh         Jails + filters + actions installer
  âœ… 02-verify-jails-v031.sh          Post-install verifier (banactions, timeouts, counts)
  âœ… 03-install-docker-block-v031.sh  Docker port + IP blocking (inet docker-block)
  âœ… 04-install-wrapper-v031.sh       F2B wrapper installer (v0.32 â†’ /usr/local/bin/f2b)
  âœ… 05-install-auto-sync-v031.sh     Initial auto-sync (Fail2Ban â†’ nftables)
  âœ… 06-install-aliases-v031.sh       Minimal f2b-* aliases (optional)
  âœ… 07-setup-docker-sync-cron-v031.sh Docker-block validate cron (every minute)
  âœ… f2b-wrapper-v031.sh              Main wrapper (50+ functions, version 0.32)
  âœ… f2b-docker-hook.sh               Immediate docker-block ban/unban hook

ğŸ“‚ filters/ (11 detection filters):
  âœ… sshd.conf                        SSH brute-force (multi-mode, slowattack)
  âœ… f2b-exploit-critical.conf        Critical exploit scanners
  âœ… f2b-dos-high.conf                DoS/DDoS patterns
  âœ… f2b-web-medium.conf              Web attacks (SQLi, path traversal, etc.)
  âœ… nginx-recon-optimized.conf       Nginx reconnaissance
  âœ… f2b-fuzzing-payloads.conf        Fuzzing payloads
  âœ… f2b-botnet-signatures.conf       Botnet/scanner signatures
  âœ… f2b-anomaly-detection.conf       Anomaly patterns
  âœ… manualblock.conf                 Manual IP banning
  âœ… recidive.conf                    Recidive jail (30d ban)
  âœ… jail.local                       11 jails (correct banaction mapping + docker hook)

ğŸ“‚ config/ (custom config):
  âœ… nginx-recon-optimized.local      Filter extension (ignoreregex, tuning)
  âœ… f2b-anomaly-detection.local      Filter extension (ignoreregex, tuning)

ğŸ“‚ action.d/ (nftables and docker actions):
  â­ nftables-common.local            Table override (inet fail2ban-filter) [CRITICAL]
  â­ nftables-multiport.conf          Generic 7d action (IPv4+IPv6)
  â­ nftables-recidive.conf           30d recidive action (FORWARD + INPUT, IPv4 only)
  â­ nftables.conf.local              Common nftables overrides (inet, f2b-input)
  â­ docker-sync-hook.conf            Fail2Ban action calling f2b-docker-hook.sh


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
UPGRADE PATHS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FROM v0.30:
  âœ… Run:
     â€¢ sudo bash INSTALL-ALL-v031.sh
  âœ… Installer will:
     â€¢ Preserve all existing bans (Fail2Ban + nftables)
     â€¢ Update wrapper from v0.30 to v0.32
     â€¢ Enable immediate docker-block ban via f2b-docker-hook.sh
     â€¢ Switch cron to "f2b docker sync validate" mode
     â€¢ Keep existing nftables structure (11+11 sets, 22 INPUT, 6 FORWARD)

FROM v0.19 / v0.20 / v0.22 / v0.24:
  âœ… Recommended:
     â€¢ Upgrade to v0.30 first using the previous MIGRATION-GUIDE
     â€¢ Then run the v0.31 installer:
       - sudo bash INSTALL-ALL-v031.sh

CLEAN INSTALL (new server):
  âœ… INSTALL-ALL-v031.sh:
     â€¢ Creates full nftables + Fail2Ban + Docker-block + sync setup
     â€¢ Installs wrapper v0.32 and auto-sync
     â€¢ Configures docker-block validate cron
     â€¢ Adds minimal wrapper aliases (optional)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
QUICK VERIFY AFTER INSTALL (v0.31)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1) Check nftables structure
sudo nft list table inet fail2ban-filter
sudo nft list table inet docker-block

2) Check jails
sudo fail2ban-client status
sudo fail2ban-client status sshd

3) Wrapper & sync
sudo f2b status
sudo f2b sync check
sudo f2b docker info
sudo f2b docker dashboard

4) Optional deep verify
sudo bash 02-verify-jails-v031.sh

If all checks pass and counts match (11 sets v4, 11 sets v6, 22 INPUT, 6 FORWARD, 11 jails) and docker-block bans are applied immediately on ban events, your system is fully protected with the v0.31 bundle.
